{"version":3,"sources":["../src/vite.ts","../src/handler/build.ts","../src/handler/css.ts","../src/handler/html.ts","../src/handler/legacy.ts","../src/handler/mix.ts","../src/handler/react.ts","../src/handler/resolve.ts","../src/handler/server.ts"],"sourcesContent":["import { ConfigEnv, defineConfig as origin, UserConfig, UserConfigExport } from 'vite';\nimport { handleBuild } from './handler/build';\nimport { handleCss } from './handler/css';\nimport { handleHtml, OverrideHtml } from './handler/html';\nimport { handleLegacy, OverrideLegacy } from './handler/legacy';\nimport { handleMix, OverrideMix } from './handler/mix';\nimport { handleReact, OverrideReact } from './handler/react';\nimport { handleResolve, OverrideResolve } from './handler/resolve';\nimport { handleServer, OverrideServer } from './handler/server';\n\ntype OverrideKeys = 'legacy' | 'server' | 'resolve';\n\nexport interface Config\n  extends OverrideMix,\n    OverrideReact,\n    OverrideLegacy,\n    OverrideHtml,\n    OverrideServer,\n    OverrideResolve,\n    Omit<UserConfig, OverrideKeys> {}\n\nexport type ConfigFn = (env: ConfigEnv) => Config;\nexport type ConfigExport = Config | ConfigFn;\n\nexport const defineConfig = (config: ConfigExport = {}): UserConfigExport => {\n  return origin((env) => {\n    return parseConfig(typeof config === 'function' ? config(env) : config, env);\n  });\n};\n\nconst parseConfig = (config: Config, env: ConfigEnv): Omit<Config, OverrideKeys> => {\n  handleReact(config);\n  delete config.react;\n  handleLegacy(config);\n  delete config.legacy;\n  handleCss(config, env);\n  handleBuild(config);\n  handleMix(config);\n  handleServer(config);\n  delete config.server?.watchExtend;\n  delete config.server?.qrcode;\n  handleHtml(config, env);\n  delete config.html;\n  handleResolve(config);\n  delete config.resolve?.aliasFromTsconfig;\n\n  return config;\n};\n","import { extname } from 'path';\nimport { OutputOptions } from 'rollup';\nimport { Config } from '../vite';\n\nconst assetPatterns = <const>[\n  ['media', /\\.(mp4|webm|ogg|mp3|wav|flac|aac|swf)(\\?.*)?$/i],\n  ['image', /\\.(png|jpe?g|gif|ico|svg|webp)(\\?.*)?$/i],\n  ['font', /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/i],\n  ['css', /\\.(s?css|less|styl)(\\?.*)?$/i],\n];\n\nexport const handleBuild = (config: Config) => {\n  config.build ||= {};\n  config.build.rollupOptions ||= {};\n  config.build.rollupOptions.output ||= {};\n\n  const keys = Object.keys(config.build.rollupOptions.output) as (keyof OutputOptions)[];\n  const overrideKeys: (keyof OutputOptions)[] = [\n    'assetFileNames',\n    'chunkFileNames',\n    'entryFileNames',\n  ];\n  const userDefined = keys.some((key) => overrideKeys.includes(key));\n\n  if (!userDefined) {\n    config.build.rollupOptions.output = {\n      ...config.build.rollupOptions.output,\n      assetFileNames(assetInfo) {\n        const ext = extname(assetInfo.name || '');\n        let prefix = 'misc';\n\n        for (const [name, pattern] of assetPatterns) {\n          if (pattern.test(ext)) {\n            prefix = name;\n            break;\n          }\n        }\n\n        return `${prefix}/[name].[hash][extname]`;\n      },\n      chunkFileNames: 'js/[name].[hash].js',\n      entryFileNames: 'js/entry-[name].[hash].js',\n    };\n  }\n};\n","import { ConfigEnv } from 'vite';\nimport { Config } from '../vite';\n\nexport const handleCss = (config: Config, env: ConfigEnv) => {\n  config.css ||= {};\n  if (config.css.modules === false) return;\n  config.css.modules ||= {};\n  config.css.modules.generateScopedName ??=\n    env.command === 'build' ? '[hash:base64]' : '[path][name]-[ext]___[local]';\n};\n","import { ConfigEnv } from 'vite';\nimport { createHtmlPlugin } from 'vite-plugin-html';\nimport { Config } from '../vite';\n\nexport interface OverrideHtml {\n  html?: false | Parameters<typeof createHtmlPlugin>[0];\n}\n\nexport const handleHtml = (config: Config, env: ConfigEnv) => {\n  if (config.html === false) return;\n\n  config.html ||= {};\n  config.html.minify ??= env.command === 'build';\n  config.plugins ||= [];\n  config.plugins.push(createHtmlPlugin(config.html));\n};\n","import legacy from '@vitejs/plugin-legacy';\nimport { Config } from '../vite';\n\nexport interface OverrideLegacy {\n  /**\n   * 兼容不支持 type=module 的浏览器\n   * @see https://caniuse.com/es6-module\n   */\n  legacy?: true | Parameters<typeof legacy>[0];\n}\n\nexport const handleLegacy = (config: Config) => {\n  if (!config.legacy) return;\n\n  config.plugins ||= [];\n  config.plugins.push(legacy(config.legacy === true ? void 0 : config.legacy));\n};\n","import { Config } from '../vite';\n\nexport interface OverrideMix {\n  /**\n   * Base public path when served in development or production.\n   * @default './'\n   */\n  base?: string;\n  /**\n   * @default false\n   */\n  clearScreen?: boolean;\n}\n\nexport const handleMix = (config: Config) => {\n  config.base ??= './';\n  config.clearScreen ??= false;\n};\n","import reactBabel, { Options as ReactBabelOptions } from '@vitejs/plugin-react';\nimport reactSWC from '@vitejs/plugin-react-swc';\nimport { Config } from '../vite';\n\nexport interface OverrideReact {\n  /**\n   * 默认使用插件 [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) 提升编译速度。\n   *\n   * 如果要使用兼容性更强的 [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react)，则设置 `swc=false`\n   */\n  react?: (ReactBabelOptions & { swc: false }) | (Parameters<typeof reactSWC>[0] & { swc?: true });\n}\n\nexport const handleReact = (config: Config) => {\n  config.plugins ||= [];\n  config.react ||= {};\n\n  if (config.react.swc !== false) {\n    config.plugins.push(reactSWC(omit(config.react)));\n  } else {\n    config.plugins.push(reactBabel(omit(config.react)));\n  }\n};\n\nconst omit = <T>(config: T & { swc?: boolean }): Omit<T, 'swc'> => {\n  delete config.swc;\n  return config;\n};\n","import tsconfigPaths, { PluginOptions } from 'vite-tsconfig-paths';\nimport { UserConfig } from 'vite';\nimport { Config } from '../vite';\n\nexport interface OverrideResolve {\n  resolve?: UserConfig['resolve'] & {\n    /**\n     * 从`tsconfig.json`中获取路径别名。默认值：`true`\n     *\n     * 插件：[vite-tsconfig-paths](https://github.com/aleclarson/vite-tsconfig-paths)\n     */\n    aliasFromTsconfig?: boolean | PluginOptions;\n  };\n}\n\nexport const handleResolve = (config: Config) => {\n  const { aliasFromTsconfig = true } = config.resolve || {};\n\n  if (aliasFromTsconfig) {\n    config.plugins ||= [];\n    config.plugins.push(tsconfigPaths(aliasFromTsconfig === true ? void 0 : aliasFromTsconfig));\n  }\n};\n","import restart from 'vite-plugin-restart';\nimport ssl from '@vitejs/plugin-basic-ssl';\nimport { qrcode as qrcodePlugin, PluginOptions as QrcodeOptions } from 'vite-plugin-qrcode';\nimport { UserConfig } from 'vite';\nimport { Config } from '../vite';\n\nexport interface OverrideServer {\n  server?: UserConfig['server'] & {\n    /**\n     * vite目前自动重启的条件有：\n     * - 修改了 `vite.config.[tj]s` 文件\n     * - 修改了 `.env[.*]` 文件\n     *\n     * 这里可以添加额外的监听文件。设置`restart`可重启服务，设置`reload`可刷新页面。\n     *\n     * 插件：[vite-plugin-restart](https://github.com/antfu/vite-plugin-restart)\n     */\n    watchExtend?: Parameters<typeof restart>[0];\n    /**\n     * 开发启动时传递`--host`或者配置了`server.host`时，将展示二维码。\n     *\n     * 默认值：`true`\n     *\n     * 插件：[vite-plugin-qrcode](https://github.com/svitejs/vite-plugin-qrcode)\n     */\n    qrcode?: boolean | QrcodeOptions;\n  };\n}\n\nexport const handleServer = (config: Config) => {\n  config.server ||= {};\n  config.preview ||= {};\n  config.server.open ??= true;\n  config.plugins ||= [];\n\n  if (config.server.https === true || config.preview.https === true) {\n    config.plugins.push(ssl());\n  }\n\n  const { watchExtend } = config.server;\n  if (watchExtend) {\n    config.plugins.push(restart(watchExtend));\n  }\n\n  const { qrcode = true } = config.server;\n  if (qrcode) {\n    config.plugins.push(qrcodePlugin(qrcode === true ? void 0 : qrcode));\n  }\n};\n"],"mappings":"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","names":[]}